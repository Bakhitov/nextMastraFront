{"version":3,"file":"background.ts-B3tj9mkb.js","sources":["../../src/background.ts"],"sourcesContent":["chrome.runtime.onInstalled.addListener(() => {\n  chrome.contextMenus.create({ id: \"send_to_agent\", title: \"Отправить текст ассистенту\", contexts: [\"selection\"] });\n});\n\nchrome.contextMenus.onClicked.addListener(async (info, tab) => {\n  if (info.menuItemId === \"send_to_agent\" && info.selectionText) {\n    const stored = await chrome.storage.local.get([\"sb-access-token\", \"accessToken\", \"user\"]);\n    const accessToken = stored?.[\"sb-access-token\"] || stored?.[\"accessToken\"];\n    const user = stored?.user;\n    if (!accessToken || !user?.id) return;\n    try {\n      const isActiveStored = (await chrome.storage.local.get([\"is_active\"]))?.is_active ?? false;\n      let isActive = Boolean(isActiveStored);\n      if (!isActive) {\n        // try fetch profile quickly to check flag\n        const baseTmp = (typeof (self as any)?.importScripts === 'function' && (self as any)?.VITE_API_BASE_URL)\n          || (typeof (globalThis as any)?.__VITE__ !== 'undefined' && (globalThis as any).__VITE__.VITE_API_BASE_URL)\n          || \"http://localhost:3000\";\n        try {\n          const me = await fetch(`${baseTmp}/api/v1/users/me`, { headers: { Authorization: `Bearer ${accessToken}` } });\n          if (me.ok) {\n            const j = await me.json();\n            isActive = Boolean(j?.profile?.is_active);\n            await chrome.storage.local.set({ is_active: isActive });\n          }\n        } catch {}\n      }\n      if (!isActive) return;\n    } catch {}\n    try {\n      // Use same base as popup code\n      // @ts-ignore\n      const base = (typeof (self as any)?.importScripts === 'function' && (self as any)?.VITE_API_BASE_URL)\n        // Fallback if build-time var is not injected in service worker context\n        || (typeof (globalThis as any)?.__VITE__ !== 'undefined' && (globalThis as any).__VITE__.VITE_API_BASE_URL)\n        // Last resort\n        || \"http://localhost:3000\";\n      const threadKey = `threadId:n8nAgent:${user.id}`;\n      const saved = await chrome.storage.local.get([threadKey]);\n      let threadId: string | null = saved?.[threadKey] ?? null;\n      if (!threadId) {\n        const threadsRes = await fetch(`${base}/api/v1/threads?resourceId=${encodeURIComponent(user.id)}&agentId=n8nAgent`, {\n          headers: { Authorization: `Bearer ${accessToken}` },\n        });\n        if (threadsRes.ok) {\n          const list = (await threadsRes.json()) as any[];\n          threadId = Array.isArray(list) && list.length > 0 ? (list[0]?.id || list[0]?.threadId || null) : null;\n          if (threadId) {\n            await chrome.storage.local.set({ [threadKey]: threadId });\n          }\n        }\n      }\n      if (!threadId) {\n        const createdRes = await fetch(`${base}/api/v1/threads`, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            Authorization: `Bearer ${accessToken}`,\n          },\n          body: JSON.stringify({ title: \"Быстрый ввод\", metadata: {}, resourceId: user.id, agentId: \"n8nAgent\" }),\n        });\n        if (createdRes.ok) {\n          const created = await createdRes.json();\n          threadId = created?.id || created?.threadId || null;\n          if (threadId) {\n            await chrome.storage.local.set({ [threadKey]: threadId });\n          }\n        }\n      }\n      if (!threadId) return;\n\n      await fetch(`${base}/api/v1/agents/n8nAgent/stream`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${accessToken}`,\n        },\n        body: JSON.stringify({ messages: [{ role: \"user\", content: info.selectionText }], memory: { thread: threadId, resource: user.id } }),\n      });\n    } catch {}\n  }\n});\n\nchrome.action.onClicked.addListener(async (tab) => {\n  if (!tab?.id) return;\n  try {\n    // Не блокируем открытие UI по is_active: пользователь должен иметь доступ к логину/настройкам,\n    // сами страницы уже ограничивают доступ к функционалу при is_active=false\n    try {\n      await chrome.tabs.sendMessage(tab.id, { type: \"toggle-panel\" });\n      // if content script not injected yet, execute and retry\n    } catch {\n      try {\n        await chrome.scripting.executeScript({ target: { tabId: tab.id }, files: [\"src/content.ts\"] });\n        await chrome.tabs.sendMessage(tab.id, { type: \"toggle-panel\" });\n      } catch {}\n    }\n    const [{ result: hasPanel }] = await chrome.scripting.executeScript({\n      target: { tabId: tab.id },\n      func: () => Boolean(document.getElementById(\"__mastra_panel\")),\n    });\n    if (!hasPanel) {\n      // Fallback: open Chrome Side Panel with our app at full height\n      try {\n        // @ts-ignore - sidePanel is available in MV3 with proper permissions\n        await chrome.sidePanel.setOptions({ tabId: tab.id, path: \"popup.html\", enabled: true });\n        // @ts-ignore\n        await chrome.sidePanel.open({ tabId: tab.id });\n      } catch {\n        // If sidePanel API not available, fallback to opening popup.html in new tab\n        await chrome.tabs.create({ url: chrome.runtime.getURL(\"popup.html\") });\n      }\n    }\n  } catch {}\n});\n\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  if (message?.type === \"close-panel\") {\n    (async () => {\n      try {\n        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });\n        if (!tab?.id) return;\n        // Try close embedded panel if exists\n        const [{ result: closed }] = await chrome.scripting.executeScript({\n          target: { tabId: tab.id },\n          func: () => {\n            const panel = document.getElementById(\"__mastra_panel\") as HTMLElement | null;\n            if (panel && panel.style.display !== \"none\") {\n              panel.style.display = \"none\";\n              return true;\n            }\n            return false;\n          },\n        });\n        if (!closed) {\n          try {\n            // @ts-ignore\n            await chrome.sidePanel.setOptions({ tabId: tab.id, enabled: false });\n          } catch {}\n        }\n      } catch {}\n    })();\n  }\n});\n\n\n"],"names":["info","tab","_a","_b","_c","_d","stored","accessToken","user","isActive","baseTmp","me","j","base","threadKey","saved","threadId","threadsRes","list","createdRes","created","hasPanel","message","sender","sendResponse","closed","panel"],"mappings":"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"}