chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"send_to_agent",title:"Отправить текст ассистенту",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener(async(e,u)=>{var m,s,h,r;if(e.menuItemId==="send_to_agent"&&e.selectionText){const n=await chrome.storage.local.get(["sb-access-token","accessToken","user"]),l=(n==null?void 0:n["sb-access-token"])||(n==null?void 0:n.accessToken),c=n==null?void 0:n.user;if(!l||!(c!=null&&c.id))return;try{let i=!!(((m=await chrome.storage.local.get(["is_active"]))==null?void 0:m.is_active)??!1);if(!i){const d=typeof(self==null?void 0:self.importScripts)=="function"&&(self==null?void 0:self.VITE_API_BASE_URL)||typeof(globalThis==null?void 0:globalThis.__VITE__)<"u"&&globalThis.__VITE__.VITE_API_BASE_URL||"http://localhost:3000";try{const t=await fetch(`${d}/api/v1/users/me`,{headers:{Authorization:`Bearer ${l}`}});if(t.ok){const o=await t.json();i=!!((s=o==null?void 0:o.profile)!=null&&s.is_active),await chrome.storage.local.set({is_active:i})}}catch{}}if(!i)return}catch{}try{const p=typeof(self==null?void 0:self.importScripts)=="function"&&(self==null?void 0:self.VITE_API_BASE_URL)||typeof(globalThis==null?void 0:globalThis.__VITE__)<"u"&&globalThis.__VITE__.VITE_API_BASE_URL||"http://localhost:3000",i=`threadId:n8nAgent:${c.id}`,d=await chrome.storage.local.get([i]);let t=(d==null?void 0:d[i])??null;if(!t){const o=await fetch(`${p}/api/v1/threads?resourceId=${encodeURIComponent(c.id)}&agentId=n8nAgent`,{headers:{Authorization:`Bearer ${l}`}});if(o.ok){const a=await o.json();t=Array.isArray(a)&&a.length>0&&(((h=a[0])==null?void 0:h.id)||((r=a[0])==null?void 0:r.threadId))||null,t&&await chrome.storage.local.set({[i]:t})}}if(!t){const o=await fetch(`${p}/api/v1/threads`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({title:"Быстрый ввод",metadata:{},resourceId:c.id,agentId:"n8nAgent"})});if(o.ok){const a=await o.json();t=(a==null?void 0:a.id)||(a==null?void 0:a.threadId)||null,t&&await chrome.storage.local.set({[i]:t})}}if(!t)return;await fetch(`${p}/api/v1/agents/n8nAgent/stream`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({messages:[{role:"user",content:e.selectionText}],memory:{thread:t,resource:c.id}})})}catch{}}});chrome.action.onClicked.addListener(async e=>{if(e!=null&&e.id)try{try{await chrome.tabs.sendMessage(e.id,{type:"toggle-panel"})}catch{try{await chrome.scripting.executeScript({target:{tabId:e.id},files:["src/content.ts"]}),await chrome.tabs.sendMessage(e.id,{type:"toggle-panel"})}catch{}}const[{result:u}]=await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>!!document.getElementById("__mastra_panel")});if(!u)try{await chrome.sidePanel.setOptions({tabId:e.id,path:"popup.html",enabled:!0}),await chrome.sidePanel.open({tabId:e.id})}catch{await chrome.tabs.create({url:chrome.runtime.getURL("popup.html")})}}catch{}});chrome.runtime.onMessage.addListener((e,u,m)=>{(e==null?void 0:e.type)==="close-panel"&&(async()=>{try{const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(s!=null&&s.id))return;const[{result:h}]=await chrome.scripting.executeScript({target:{tabId:s.id},func:()=>{const r=document.getElementById("__mastra_panel");return r&&r.style.display!=="none"?(r.style.display="none",!0):!1}});if(!h)try{await chrome.sidePanel.setOptions({tabId:s.id,enabled:!1})}catch{}}catch{}})()});
//# sourceMappingURL=background.ts-B3tj9mkb.js.map
